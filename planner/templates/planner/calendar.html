{% extends 'base.html' %}

{% block title %}Calendar - TaskFlow{% endblock %}

{% block content %}
<div class="h-full flex flex-col p-6" x-data="calendarApp()" x-init="init()">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Calendar</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-1">
                {{ week_start|date:"F j" }} - {{ week_end|date:"F j, Y" }}
            </p>
        </div>
        
        <div class="flex items-center space-x-4">
            <!-- Week Navigation -->
            <div class="flex items-center space-x-2">
                <button @click="navigateWeek(-1)" 
                        class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                    <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </button>
                
                <button @click="goToToday()" 
                        class="px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors">
                    Today
                </button>
                
                <button @click="navigateWeek(1)" 
                        class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                    <svg class="w-5 h-5 text-gray-600 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
            
            <!-- Re-optimize Button -->
            <button @click="reoptimizeSchedule()" 
                    :disabled="isOptimizing"
                    class="bg-primary hover:bg-blue-600 disabled:opacity-50 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2">
                <svg class="w-4 h-4" :class="{ 'animate-spin': isOptimizing }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                <span x-text="isOptimizing ? 'Optimizing...' : 'Re-optimize'"></span>
            </button>
        </div>
    </div>

    <!-- Calendar Container -->
    <div class="flex-1 flex gap-6">
        <!-- Main Calendar Grid -->
        <div class="flex-1 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
            <!-- Calendar Header - Day Names -->
            <div class="calendar-header">
                <!-- Empty corner for time column -->
                <div class="time-column-header"></div>
                <!-- Day headers -->
                {% for day in week_days %}
                <div class="day-header {% if day.is_today %}today{% endif %}">
                    <div class="day-name">{{ day.day_short }}</div>
                    <div class="day-number">{{ day.day_num }}</div>
                </div>
                {% endfor %}
            </div>

            <!-- Calendar Body with Time Grid -->
            <div class="calendar-body">
                <!-- Time Column -->
                <div class="time-column">
                    {% for hour in "6789101112131415161718192021222324"|make_list %}
                    <div class="time-slot">
                        <span class="time-label">
                            {% if hour == "0" %}12 AM
                            {% elif hour|add:0 <= 11 %}{{ hour|add:0 }}:00 AM
                            {% elif hour == "12" %}12 PM
                            {% else %}{{ hour|add:0|add:-12 }}:00 PM
                            {% endif %}
                        </span>
                    </div>
                    {% endfor %}
                </div>

                <!-- Days Grid -->
                <div class="days-grid">
                    {% for day in week_days %}
                    <div class="day-column" data-date="{{ day.date|date:'Y-m-d' }}">
                        <!-- Hour slots for this day -->
                        {% for hour in "6789101112131415161718192021222324"|make_list %}
                        <div class="hour-slot" 
                             data-hour="{{ hour }}"
                             @dragover.prevent="handleDragOver($event)"
                             @drop="handleDrop($event, '{{ day.date|date:'Y-m-d' }}', {{ hour }})"
                             @click="quickAddTask('{{ day.date|date:'Y-m-d' }}', {{ hour }})">
                        </div>
                        {% endfor %}

                        <!-- Render tasks for this day -->
                        {% for task in day.tasks %}
                        <div class="task-block"
                             draggable="true"
                             data-task-id="{{ task.id }}"
                             @dragstart="handleTaskDragStart($event, {{ task.id }})"
                             style="
                                top: {{ task.start_time.hour|add:-6 }}rem;
                                height: {{ task.estimated_hours|floatformat:1 }}rem;
                             ">
                            <div class="task-content">
                                <div class="task-title">{{ task.title }}</div>
                                <div class="task-time">{{ task.start_time|date:"g:i A" }}</div>
                                {% if task.is_locked %}
                                <div class="task-lock">
                                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                {% endif %}
                                <button class="task-remove" @click.stop="unscheduleTask({{ task.id }})">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Unscheduled Tasks Sidebar -->
        <div class="w-80 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 flex flex-col">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Unscheduled Tasks</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                    {{ unscheduled_tasks.count }} tasks need scheduling
                </p>
            </div>
            
            <div class="flex-1 p-4 space-y-3 overflow-y-auto">
                {% for task in unscheduled_tasks %}
                <div class="unscheduled-task"
                     draggable="true"
                     data-task-id="{{ task.id }}"
                     @dragstart="handleTaskDragStart($event, {{ task.id }})">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900 dark:text-white text-sm">{{ task.title }}</h4>
                            <div class="flex items-center space-x-3 mt-1 text-xs text-gray-500 dark:text-gray-400">
                                <span>{{ task.estimated_hours }}h</span>
                                <span>Due: {{ task.deadline|date:"M j" }}</span>
                            </div>
                        </div>
                        <div class="priority-indicator priority-{{ task.priority }}"></div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-8 text-gray-400 dark:text-gray-500">
                    <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p class="text-sm">All tasks scheduled!</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
</div>

<style>
/* Google Calendar Style CSS */
.calendar-header {
    display: grid;
    grid-template-columns: 80px repeat(7, 1fr);
    border-bottom: 1px solid #e5e7eb;
    background-color: #f9fafb;
}

.dark .calendar-header {
    border-bottom-color: #374151;
    background-color: #111827;
}

.time-column-header {
    border-right: 1px solid #e5e7eb;
}

.dark .time-column-header {
    border-right-color: #374151;
}

.day-header {
    padding: 16px 8px;
    text-align: center;
    border-right: 1px solid #e5e7eb;
}

.day-header:last-child {
    border-right: none;
}

.day-header.today {
    background-color: #dbeafe;
}

.dark .day-header {
    border-right-color: #374151;
}

.dark .day-header.today {
    background-color: #1e3a8a;
}

.day-name {
    font-size: 0.875rem;
    font-weight: 500;
    color: #6b7280;
}

.dark .day-name {
    color: #9ca3af;
}

.day-number {
    font-size: 1.125rem;
    font-weight: 700;
    color: #111827;
    margin-top: 4px;
}

.day-header.today .day-number {
    color: #2563eb;
}

.dark .day-number {
    color: #f9fafb;
}

.dark .day-header.today .day-number {
    color: #60a5fa;
}

.calendar-body {
    display: grid;
    grid-template-columns: 80px 1fr;
    height: 600px;
    overflow-y: auto;
}

.time-column {
    border-right: 1px solid #e5e7eb;
    background-color: #f9fafb;
}

.dark .time-column {
    border-right-color: #374151;
    background-color: #111827;
}

.time-slot {
    height: 4rem;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 4px;
    border-bottom: 1px solid #f3f4f6;
    position: relative;
}

.dark .time-slot {
    border-bottom-color: #374151;
}

.time-label {
    font-size: 0.75rem;
    color: #6b7280;
    font-weight: 500;
}

.dark .time-label {
    color: #9ca3af;
}

.days-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    position: relative;
}

.day-column {
    border-right: 1px solid #e5e7eb;
    position: relative;
}

.day-column:last-child {
    border-right: none;
}

.dark .day-column {
    border-right-color: #374151;
}

.hour-slot {
    height: 4rem;
    border-bottom: 1px solid #f3f4f6;
    cursor: pointer;
    transition: background-color 0.15s ease;
}

.hour-slot:hover {
    background-color: #f3f4f6;
}

.dark .hour-slot {
    border-bottom-color: #374151;
}

.dark .hour-slot:hover {
    background-color: #374151;
}

.task-block {
    position: absolute;
    left: 2px;
    right: 2px;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border-radius: 6px;
    padding: 6px;
    font-size: 0.75rem;
    cursor: move;
    z-index: 10;
    min-height: 2rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: all 0.15s ease;
}

.task-block:hover {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    transform: translateY(-1px);
}

.task-content {
    position: relative;
}

.task-title {
    font-weight: 600;
    line-height: 1.2;
    margin-bottom: 2px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.task-time {
    font-size: 0.625rem;
    opacity: 0.9;
}

.task-lock {
    position: absolute;
    top: 2px;
    right: 20px;
    opacity: 0.7;
}

.task-remove {
    position: absolute;
    top: 2px;
    right: 2px;
    opacity: 0;
    transition: opacity 0.15s ease;
    color: white;
    hover:opacity-100;
}

.task-block:hover .task-remove {
    opacity: 1;
}

.unscheduled-task {
    background-color: #fef3c7;
    border: 1px solid #f59e0b;
    border-left: 4px solid #f59e0b;
    border-radius: 6px;
    padding: 12px;
    cursor: move;
    transition: all 0.15s ease;
}

.unscheduled-task:hover {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
}

.dark .unscheduled-task {
    background-color: #451a03;
    border-color: #92400e;
}

.priority-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}

.priority-1 { background-color: #10b981; }
.priority-2 { background-color: #f59e0b; }
.priority-3 { background-color: #ef4444; }
.priority-4 { background-color: #dc2626; }

/* Drag feedback */
.dragging {
    opacity: 0.5;
    transform: scale(0.95);
}

.drag-over {
    background-color: #dbeafe !important;
}

.dark .drag-over {
    background-color: #1e40af !important;
}
</style>

<script>
function calendarApp() {
    return {
        isOptimizing: false,
        
        init() {
            console.log('Calendar initialized');
        },
        
        navigateWeek(direction) {
            const params = new URLSearchParams(window.location.search);
            const currentWeek = params.get('week') || new Date().toISOString().split('T')[0];
            const date = new Date(currentWeek);
            date.setDate(date.getDate() + (direction * 7));
            params.set('week', date.toISOString().split('T')[0]);
            window.location.search = params.toString();
        },
        
        goToToday() {
            const params = new URLSearchParams(window.location.search);
            params.delete('week');
            window.location.search = params.toString();
        },
        
        handleTaskDragStart(event, taskId) {
            event.dataTransfer.setData('text/plain', taskId);
            event.target.classList.add('dragging');
        },
        
        handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        },
        
        handleDrop(event, date, hour) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            const taskId = event.dataTransfer.getData('text/plain');
            if (taskId) {
                this.scheduleTask(taskId, date, hour);
            }
            
            // Remove dragging class from all elements
            document.querySelectorAll('.dragging').forEach(el => {
                el.classList.remove('dragging');
            });
        },
        
        scheduleTask(taskId, date, hour) {
            const startTime = new Date(`${date}T${hour.toString().padStart(2, '0')}:00:00`);
            
            fetch('{% url "planner:update_task_schedule" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `task_id=${taskId}&start_time=${startTime.toISOString()}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showToast('Task scheduled successfully!', 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    this.showToast('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                this.showToast('Network error', 'error');
            });
        },
        
        unscheduleTask(taskId) {
            if (!confirm('Remove this task from the schedule?')) return;
            
            fetch('{% url "planner:unschedule_task" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `task_id=${taskId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.showToast('Task unscheduled!', 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    this.showToast('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            });
        },
        
        quickAddTask(date, hour) {
            // Quick task creation - can be enhanced later
            const title = prompt('Task title:');
            if (!title) return;
            
            const hours = prompt('Estimated hours:', '1');
            if (!hours) return;
            
            // Create task and schedule it
            // This would need a proper API endpoint
            console.log(`Creating task "${title}" for ${hours}h at ${date} ${hour}:00`);
        },
        
        reoptimizeSchedule() {
            this.isOptimizing = true;
            
            fetch('{% url "planner:reoptimize_week" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                this.isOptimizing = false;
                
                if (data.success) {
                    this.showToast('Schedule optimized!', 'success');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    this.showToast('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                this.isOptimizing = false;
                console.error('Error:', error);
                this.showToast('Network error', 'error');
            });
        },
        
        showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const bgColor = type === 'success' ? 'bg-green-500' : 
                           type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            toast.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300`;
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `;
            
            container.appendChild(toast);
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }
    }
}
</script>
{% endblock %}
