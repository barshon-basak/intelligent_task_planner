{% extends 'base.html' %}
{% load static %}
{% load math_filters %}

{% block title %}Habit Dashboard - Intelligent Task Planner{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
{% csrf_token %}
<!-- Ensure CSRF token is available for JavaScript -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<div class="max-w-7xl mx-auto">
    <!-- Header Section -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Habit Dashboard</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2">Track your daily habits and build lasting routines</p>
        </div>
        <div class="flex gap-3">
            <a href="{% url 'planner:habit_create' %}" 
               class="btn-primary flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Add Habit
            </a>
            <a href="{% url 'planner:habit_list' %}" 
               class="btn-secondary flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                </svg>
                View All
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="glass-card p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Habits</p>
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white">{{ stats.total_habits }}</p>
                </div>
            </div>
        </div>

        <div class="glass-card p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Completed Today</p>
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white">{{ stats.completed_today }}</p>
                </div>
            </div>
        </div>

        <div class="glass-card p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-purple-500 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Active Streaks</p>
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white">{{ stats.active_streaks }}</p>
                </div>
            </div>
        </div>

        <div class="glass-card p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-orange-500 rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Pending Today</p>
                    <p class="text-2xl font-semibold text-gray-900 dark:text-white">{{ stats.pending_today }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Today's Habits -->
        <div class="lg:col-span-2">
            <div class="glass-card p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Today's Habits</h2>
                    <span class="text-sm text-gray-500 dark:text-gray-400">{{ today|date:"F j, Y" }}</span>
                </div>

                {% if habits %}
                    <div class="space-y-4">
                        {% for habit in habits %}
                            {% with entry=today_entries|get_item:habit.id %}
                            <div class="habit-card p-4 border border-gray-200 dark:border-gray-700 rounded-lg transition-all hover:shadow-md"
                                 style="border-left: 4px solid {{ habit.color }};">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-3">
                                            <button onclick="toggleHabit({{ habit.id }})" 
                                                    class="habit-toggle w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors
                                                           {% if entry and entry.is_completed %}bg-green-500 border-green-500{% else %}border-gray-300 hover:border-green-400{% endif %}"
                                                    data-habit-id="{{ habit.id }}"
                                                    data-completed="{% if entry and entry.is_completed %}true{% else %}false{% endif %}">
                                                {% if entry and entry.is_completed %}
                                                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                    </svg>
                                                {% endif %}
                                            </button>
                                            <div>
                                                <h3 class="font-medium text-gray-900 dark:text-white">{{ habit.title }}</h3>
                                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                                    {{ habit.get_category_display }} • {{ habit.get_target_frequency_display }}
                                                    {% if habit.unit %} • {{ habit.target_count }} {{ habit.unit }}{% endif %}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <div class="text-right">
                                            <p class="text-sm font-medium text-gray-900 dark:text-white">
                                                🔥 {{ habit.current_streak }} day{{ habit.current_streak|pluralize }}
                                            </p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                                {{ habit.completion_rate }}% completion
                                            </p>
                                        </div>
                                        <a href="{% url 'planner:habit_detail' habit.pk %}" 
                                           class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                            </svg>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endwith %}
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No habits yet</h3>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Get started by creating your first habit.</p>
                        <div class="mt-6">
                            <a href="{% url 'planner:habit_create' %}" class="btn-primary">Create your first habit</a>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Weekly Progress Chart -->
            <div class="glass-card p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Weekly Progress</h3>
                <div class="chart-container" style="position: relative; height: 200px; width: 100%; overflow: hidden;">
                    <canvas id="weeklyChart" style="max-height: 200px;"></canvas>
                </div>
            </div>

            <!-- Recent Achievements -->
            <div class="glass-card p-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Recent Achievements</h3>
                {% if recent_achievements %}
                    <div class="space-y-3">
                        {% for achievement in recent_achievements %}
                            <div class="flex items-center space-x-3 p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                                <span class="text-xl">🏆</span>
                                <div>
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">{{ achievement.title }}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">{{ achievement.achieved_at|timesince }} ago</p>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-sm text-gray-500 dark:text-gray-400">No achievements yet. Keep building your habits!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
// CSRF token setup - Try multiple methods to get the token
function getCSRFToken() {
    // Try multiple ways to get CSRF token
    let token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    if (!token) {
        token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    }
    if (!token) {
        token = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
    }
    if (!token) {
        // Last resort - try to find it in any form on the page
        const forms = document.querySelectorAll('form');
        for (const form of forms) {
            const input = form.querySelector('input[name="csrfmiddlewaretoken"]');
            if (input) {
                token = input.value;
                break;
            }
        }
    }
    return token;
}

const csrfToken = getCSRFToken();

// Toggle habit completion
async function toggleHabit(habitId) {
    console.log('toggleHabit called with habitId:', habitId);
    
    const button = document.querySelector(`[data-habit-id="${habitId}"]`);
    if (!button) {
        console.error('Button not found for habit ID:', habitId);
        showNotification('Habit button not found. Please refresh the page.', 'error');
        return;
    }
    
    const isCompleted = button.dataset.completed === 'true';
    console.log('Current completion status:', isCompleted);
    
    // Get fresh CSRF token
    const token = getCSRFToken();
    console.log('CSRF token found:', !!token);
    
    if (!token) {
        console.error('CSRF token not found');
        showNotification('Security token not found. Please refresh the page.', 'error');
        return;
    }
    
    // Disable button during request
    button.disabled = true;
    
    try {
        const url = `/api/habits/${habitId}/toggle/`;
        console.log('Making request to:', url);
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': token,
                'Content-Type': 'application/json',
            },
        });
        
        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Response error text:', errorText);
            throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
        }
        
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success) {
            // Update button state
            button.dataset.completed = data.completed;
            
            if (data.completed) {
                button.className = button.className.replace('border-gray-300 hover:border-green-400', 'bg-green-500 border-green-500');
                button.innerHTML = `
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                `;
                showNotification('🎉 Habit marked as complete!', 'success');
            } else {
                button.className = button.className.replace('bg-green-500 border-green-500', 'border-gray-300 hover:border-green-400');
                button.innerHTML = '';
                showNotification('Habit marked as incomplete.', 'info');
            }
            
            // Update streak display
            const streakElement = button.closest('.habit-card').querySelector('.text-right p');
            if (streakElement) {
                streakElement.textContent = `🔥 ${data.current_streak} day${data.current_streak !== 1 ? 's' : ''}`;
            }
            
            // Update completion rate
            const rateElement = button.closest('.habit-card').querySelector('.text-right p:last-child');
            if (rateElement) {
                rateElement.textContent = `${data.completion_rate}% completion`;
            }
            
            // Show achievement notifications
            if (data.milestones_achieved && data.milestones_achieved.length > 0) {
                data.milestones_achieved.forEach(milestone => {
                    showNotification(`🏆 Achievement unlocked: ${milestone}!`, 'success');
                });
            }
            
            // Update stats in header
            updateDashboardStats();
        } else {
            throw new Error(data.error || 'Unknown error occurred');
        }
    } catch (error) {
        console.error('Error toggling habit:', error);
        showNotification(`Error updating habit: ${error.message}`, 'error');
    } finally {
        // Re-enable button
        button.disabled = false;
    }
}

// Function to update dashboard stats without full page reload
function updateDashboardStats() {
    // This would ideally make an AJAX call to get updated stats
    // For now, we'll just reload after a short delay
    setTimeout(() => location.reload(), 1500);
}

// Weekly progress chart - Initialize after DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    const weekData = {{ week_data|safe }};
    const ctx = document.getElementById('weeklyChart');
    
    if (ctx && weekData) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: weekData.map(d => d.date),
                datasets: [{
                    label: 'Completion Rate (%)',
                    data: weekData.map(d => d.rate),
                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1,
                    borderRadius: 4,
                    borderSkipped: false,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: 'rgba(229, 231, 235, 0.5)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            },
                            stepSize: 25
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Completion: ' + context.parsed.y + '%';
                            }
                        }
                    }
                },
                animation: {
                    duration: 750,
                    easing: 'easeInOutQuart'
                }
            }
        });
    }
});

// Notification system
function showNotification(message, type = 'info') {
    console.log('showNotification called:', message, type);
    
    // Remove any existing notifications first
    const existingNotifications = document.querySelectorAll('.habit-notification');
    existingNotifications.forEach(notif => notif.remove());
    
    const notification = document.createElement('div');
    notification.className = `habit-notification fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all transform translate-x-full max-w-sm`;
    
    if (type === 'success') {
        notification.className += ' bg-green-500 text-white';
    } else if (type === 'error') {
        notification.className += ' bg-red-500 text-white';
    } else if (type === 'info') {
        notification.className += ' bg-blue-500 text-white';
    } else {
        notification.className += ' bg-gray-500 text-white';
    }
    
    notification.innerHTML = `
        <div class="flex items-center justify-between">
            <span class="flex-1">${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // Remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.classList.add('translate-x-full');
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 300);
        }
    }, 5000);
}
</script>
{% endblock %}